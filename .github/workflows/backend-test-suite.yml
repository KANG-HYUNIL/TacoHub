# ë°±ì—”ë“œ API ì„œë²„ ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì›Œí¬í”Œë¡œìš° (Java 21)
# ëª©ì : ëª¨ë“  ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì½”ë“œ í’ˆì§ˆ ë³´ì¥
name: Backend API Server Test Suite

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì„¤ì •
on:
  # ì½”ë“œê°€ main ë˜ëŠ” dev ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  push:
    branches: [ dev ]
    # ë°±ì—”ë“œ ì½”ë“œë‚˜ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'BackEnd/**'
      - '.github/workflows/backend-test-suite.yml'
  
  # Pull Requestê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'BackEnd/**'
      - '.github/workflows/backend-test-suite.yml'
  
  # ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ì •ê¸° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì½”ë“œ íšŒê·€ ë°©ì§€)
  schedule:
    - cron: '0 2 * * *'
  
  # ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
  workflow_dispatch:

# ì‘ì—… ì •ì˜
jobs:
  # ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‘ì—…
  test-suite:
    # GitHubì˜ ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    # ì‘ì—… íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„)
    timeout-minutes: 30
    
    env:
      # í…ŒìŠ¤íŠ¸ìš© í”„ë¡œíŒŒì¼ ì‚¬ìš©
      SPRING_PROFILES_ACTIVE: test
      # Java 21 ìµœì í™” ì˜µì…˜
      JAVA_TOOL_OPTIONS: "--enable-preview -XX:+UseZGC -XX:+UnlockExperimentalVMOptions"
      
      # AWS ìê²©ì¦ëª…
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      
      # JWT ë³´ì•ˆ í‚¤
      JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
      JWT_ACCESS_EXPIRATION: ${{ secrets.JWT_ACCESS_EXPIRATION }}
      JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
      JWT_REFRESH_EXPIRATION: ${{ secrets.JWT_REFRESH_EXPIRATION }}
      
      # ì´ë©”ì¼ ì„¤ì •
      MAIL_HOST: ${{ secrets.MAIL_HOST }}
      MAIL_PORT: ${{ secrets.MAIL_PORT }}
      MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      MAIL_PROTOCOL: ${{ secrets.MAIL_PROTOCOL }}
      MAIL_AUTH: ${{ secrets.MAIL_AUTH }}
      MAIL_STARTTLS_ENABLE: ${{ secrets.MAIL_STARTTLS_ENABLE }}
      MAIL_STARTTLS_REQUIRED: ${{ secrets.MAIL_STARTTLS_REQUIRED }}
      MAIL_CONNECTION_TIMEOUT: ${{ secrets.MAIL_CONNECTION_TIMEOUT }}
      MAIL_TIMEOUT: ${{ secrets.MAIL_TIMEOUT }}
      MAIL_WRITE_TIMEOUT: ${{ secrets.MAIL_WRITE_TIMEOUT }}
      MAIL_AUTH_CODE_EXPIRATION: ${{ secrets.MAIL_AUTH_CODE_EXPIRATION }}
      

    # ì‘ì—… ì‹¤í–‰ ë‹¨ê³„ë“¤
    steps:
    # 1ë‹¨ê³„: ì €ì¥ì†Œ ì½”ë“œë¥¼ GitHub Actions ì‹¤í–‰ í™˜ê²½ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        # ê¹Šì€ íˆìŠ¤í† ë¦¬ë„ ê°€ì ¸ì˜¤ê¸° (ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¶„ì„ìš©)
        fetch-depth: 0
        
    # 2ë‹¨ê³„: Java 21 ê°œë°œ í™˜ê²½ ì„¤ì •
    - name: â˜• Java 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        check-latest: true
        # Java 21ì˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤ì„ ìœ„í•œ ì„¤ì •
        
    # 3ë‹¨ê³„: Gradle ì˜ì¡´ì„± ìºì‹± (ë¹Œë“œ ì†ë„ í–¥ìƒ)
    - name: ğŸ“¦ Gradle ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-test-java21-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-test-java21-
          ${{ runner.os }}-gradle-test-
          ${{ runner.os }}-gradle-

    # 4ë‹¨ê³„: Docker Composeë¡œ í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤ ë° ì„œë¹„ìŠ¤ ì‹œì‘
    - name: ğŸ³ í…ŒìŠ¤íŠ¸ìš© Docker ì„œë¹„ìŠ¤ ì‹œì‘
      run: |
        cd BackEnd/TacoHub
        
        echo "ğŸ³ í…ŒìŠ¤íŠ¸ìš© ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
        # í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ì„œë¹„ìŠ¤ë“¤ë§Œ ì‹œì‘ (ì„±ëŠ¥ ìµœì í™”)
        docker-compose -f compose.yaml up -d mysql mongodb redis rabbitmq
        
        # ì‹¤í–‰ëœ ì»¨í…Œì´ë„ˆ í™•ì¸
        echo "ğŸ” ì‹¤í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
    # 5ë‹¨ê³„: í…ŒìŠ¤íŠ¸ìš© ì„œë¹„ìŠ¤ë“¤ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    - name: â³ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
      run: |
        cd BackEnd/TacoHub
        
        echo "â±ï¸ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤ë“¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
        
        # MySQL ì¤€ë¹„ ëŒ€ê¸°
        echo "MySQL ëŒ€ê¸° ì¤‘..."
        timeout 60s bash -c 'until docker-compose exec -T mysql mysqladmin ping -h localhost --silent; do sleep 2; done'
        
        # MongoDB ì¤€ë¹„ ëŒ€ê¸°
        echo "MongoDB ëŒ€ê¸° ì¤‘..."
        timeout 60s bash -c 'until docker-compose exec -T mongodb mongosh --eval "db.adminCommand(\"ping\")" --quiet; do sleep 2; done'
        
        # Redis ì¤€ë¹„ ëŒ€ê¸°
        echo "Redis ëŒ€ê¸° ì¤‘..."
        timeout 30s bash -c 'until docker-compose exec -T redis redis-cli ping | grep -q PONG; do sleep 2; done'
        
        # RabbitMQ ì¤€ë¹„ ëŒ€ê¸°
        echo "RabbitMQ ëŒ€ê¸° ì¤‘..."
        timeout 60s bash -c 'until docker-compose exec -T rabbitmq rabbitmqctl status > /dev/null 2>&1; do sleep 2; done'
        
        echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!"

    # 6ë‹¨ê³„: Gradle ê¶Œí•œ ì„¤ì •
    - name: ğŸ”§ Gradle ê¶Œí•œ ì„¤ì •
      run: |
        cd BackEnd/TacoHub
        chmod +x ./gradlew

    # 7ë‹¨ê³„: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        cd BackEnd/TacoHub
        
        echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (í†µí•© í…ŒìŠ¤íŠ¸ ì œì™¸)
        # Java 21ì˜ ì„±ëŠ¥ ìµœì í™” ì˜µì…˜ ì ìš©
        ./gradlew test --tests "*Test" --parallel --max-workers=4
        
        echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
     


    # 8ë‹¨ê³„: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        cd BackEnd/TacoHub
        
        echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë³´í†µ *IT ë˜ëŠ” *IntegrationTest ì´ë¦„ íŒ¨í„´ ì‚¬ìš©)
        ./gradlew test --tests "*IT" --tests "*IntegrationTest" --parallel --max-workers=2
        
        echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
      
    # 9ë‹¨ê³„: ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ìƒì„±
    - name: ğŸ“Š ì „ì²´ í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ìƒì„±
      run: |
        cd BackEnd/TacoHub
        
        echo "ğŸ“Š ì „ì²´ í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ìƒì„± ì¤‘..."
        # ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ + JaCoCo ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±
        ./gradlew jacocoTestReport --parallel
        
        echo "âœ… í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€ ìƒì„± ì™„ë£Œ!"
      
    # 10ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
    - name: ğŸ“¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()  # í…ŒìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
      uses: actions/upload-artifact@v4
      with:
        name: test-results-java21
        path: |
          BackEnd/TacoHub/build/reports/tests/
          BackEnd/TacoHub/build/test-results/
        retention-days: 30  # 30ì¼ê°„ ë³´ê´€

    # 11ë‹¨ê³„: ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
    - name: ğŸ“ˆ ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-java21
        path: |
          BackEnd/TacoHub/build/reports/jacoco/
          BackEnd/TacoHub/build/jacocoHtml/
        retention-days: 30

    # 12ë‹¨ê³„: ì½”ë“œ ì»¤ë²„ë¦¬ì§€ë¥¼ Codecovì— ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)
    - name: ğŸ“Š Codecovì— ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      if: success()  # í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
      uses: codecov/codecov-action@v4
      with:
        file: BackEnd/TacoHub/build/reports/jacoco/test/jacocoTestReport.xml
        fail_ci_if_error: false  # ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨í•´ë„ CIëŠ” ì„±ê³µ
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}  # Codecov í† í° (í•„ìš”ì‹œ ì„¤ì •)

    # 13ë‹¨ê³„: Java 21 íŠ¹í™” ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
    - name: âš¡ Java 21 ì„±ëŠ¥ ë¶„ì„
      if: success()
      run: |
        cd BackEnd/TacoHub
        
        echo "âš¡ Java 21 ì„±ëŠ¥ ë¶„ì„ ì‹œì‘..."
        echo "================================"
        
        # JVM ì •ë³´ ì¶œë ¥
        java --version
        echo "JVM Flags: $JAVA_TOOL_OPTIONS"
        
        # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„ ë¶„ì„
        if [ -d "build/test-results/test" ]; then
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„ í†µê³„:"
          find build/test-results/test -name "*.xml" -exec grep -h "time=" {} \; | \
            sed 's/.*time="\([^"]*\)".*/\1/' | \
            awk '{sum+=$1; count++} END {printf "í‰ê·  í…ŒìŠ¤íŠ¸ ì‹œê°„: %.3fì´ˆ, ì´ í…ŒìŠ¤íŠ¸: %dê°œ\n", sum/count, count}'
        fi
        
        echo "================================"


    # 14ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ìƒì„±
    - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        cd BackEnd/TacoHub
        
        echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (Java 21):"
        echo "================================"
        
        # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ í™•ì¸
        if [ -d "build/test-results/test" ]; then
          echo "âœ… ì‹¤í–‰ëœ í…ŒìŠ¤íŠ¸ íŒŒì¼ë“¤:"
          find build/test-results/test -name "*.xml" | wc -l
          
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ í†µê³„:"
          # XML ê²°ê³¼ íŒŒì¼ì—ì„œ í…ŒìŠ¤íŠ¸ í†µê³„ ì¶”ì¶œ
          grep -h "testsuite" build/test-results/test/*.xml | head -5
          
          # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
          FAILED_TESTS=$(grep -r "failure\|error" build/test-results/test/ | wc -l)
          if [ $FAILED_TESTS -gt 0 ]; then
            echo "âŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìˆ˜: $FAILED_TESTS"
          else
            echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
          fi
        else
          echo "âŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        echo "================================"

    # 15ë‹¨ê³„: ì •ë¦¬ ì‘ì—… (í•­ìƒ ì‹¤í–‰)
    - name: ğŸ§¹ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
      if: always()
      run: |
        cd BackEnd/TacoHub
        
        echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬ ì¤‘..."
        
        # Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬
        docker-compose -f compose.yaml down -v
        
        # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        docker system prune -f
        
        echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

    # 16ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ìŠ¬ë™ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    - name: ğŸ“¢ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "âŒ Java 21 í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ” ì‹¤íŒ¨ ì›ì¸ì„ ë¶„ì„í•˜ê¸° ìœ„í•´ ì—…ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        echo "ğŸ“ í…ŒìŠ¤íŠ¸ ê²°ê³¼: test-results-java21"
        echo "ğŸ“ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸: coverage-report-java21"
        echo "âš¡ Java 21ì˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ ê´€ë ¨ ì´ìŠˆì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
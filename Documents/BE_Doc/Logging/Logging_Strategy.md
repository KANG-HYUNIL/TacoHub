# 로깅 시스템 구조 및 전략

## 1. 개요

TacoHub의 로깅 시스템은 **AOP 감사 로깅**과 **애플리케이션 로깅** 두 가지 독립적인 경로로 구성됩니다. 각각 다른 목적과 저장 전략을 가지며, 환경별로 최적화된 설정을 제공합니다.

## 2. 로깅 시스템 아키텍처

### 2.1 이중 로깅 구조의 설계 이유

**분리된 관심사 (Separation of Concerns)**
- **AOP 감사 로깅**: 비즈니스 도메인 로직의 추적과 감사
- **애플리케이션 로깅**: 시스템 운영과 기술적 모니터링

**각기 다른 목적과 요구사항**
- **감사 로깅**: 구조화된 데이터, 장기 보관, 법적 규정 준수
- **시스템 로깅**: 실시간 모니터링, 빠른 문제 진단, 운영 편의성

### 2.2 로그 경로 분리 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    TacoHub 애플리케이션                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐           ┌──────────────────────┐     │
│  │   비즈니스 로직   │           │   시스템/오류 로그     │     │
│  │                 │           │                      │     │
│  │ @AuditLogging   │           │ log.error()          │     │
│  │ 어노테이션       │           │ log.warn()           │     │
│  │                 │           │ log.info()           │     │
│  └─────────────────┘           └──────────────────────┘     │
│          │                              │                  │
│          ▼                              ▼                  │
│  ┌─────────────────┐           ┌──────────────────────┐     │
│  │ AuditLoggingAspect│         │     SLF4J/Logback    │     │
│  │                 │           │                      │     │
│  │ • 구조화된 데이터 │           │ • 텍스트 기반 로그    │     │
│  │ • 사용자 추적     │           │ • 시스템 모니터링     │     │
│  │ • 파라미터 기록   │           │ • 오류 추적          │     │
│  └─────────────────┘           └──────────────────────┘     │
│          │                              │                  │
└──────────┼──────────────────────────────┼──────────────────┘
           │                              │
           ▼                              ▼
┌─────────────────┐           ┌──────────────────────┐
│ AuditLogService │           │    CloudWatch        │
│                 │           │                      │
│ • File 저장     │           │ • 실시간 모니터링     │
│ • S3 아카이빙   │           │ • 알람 설정          │
│ • 장기 보관     │           │ • 로그 검색          │
└─────────────────┘           └──────────────────────┘
```

### 2.3 환경별 로깅 전략

#### Local (개발 환경)
**목적**: 개발 편의성 및 빠른 디버깅
- **AOP 감사 로깅**: 파일만 저장 (file)
- **애플리케이션 로깅**: 콘솔 + 파일
- **로그 레벨**: DEBUG (상세한 정보)
- **특징**: 모든 로그를 즉시 확인 가능

#### Test (테스트/스테이징 환경)
**목적**: 운영 환경 시뮬레이션 및 오류 모니터링
- **AOP 감사 로깅**: 파일 + CloudWatch (오류만)
- **애플리케이션 로깅**: 파일 + CloudWatch (ERROR/WARN만)
- **로그 레벨**: INFO
- **특징**: 비용 최적화하면서 중요한 오류 모니터링

#### Production (운영 환경)
**목적**: 완전한 감사 추적 및 장기 보관
- **AOP 감사 로깅**: 파일 + CloudWatch + S3 (3중 백업)
- **애플리케이션 로깅**: 파일 + CloudWatch (모든 레벨)
- **로그 레벨**: INFO
- **특징**: 완전한 모니터링과 7년 장기 보관 지원

## 3. 저장 전략 및 라이프사이클

### 3.1 저장소별 특성과 용도

#### File Storage (로컬 파일)
- **용도**: 즉시 접근 가능한 로컬 백업
- **보관 기간**: 7-30일 (디스크 용량에 따라)
- **장점**: 빠른 접근, 네트워크 독립적
- **단점**: 서버 장애 시 손실 위험

#### CloudWatch
- **용도**: 실시간 모니터링 및 알람
- **보관 기간**: 7-30일
- **장점**: 실시간 검색, 알람 연동, 대시보드
- **단점**: 상대적으로 높은 비용

#### S3 Storage
- **용도**: 장기 보관 및 규정 준수
- **보관 기간**: 7년 (자동 라이프사이클)
- **장점**: 저렴한 비용, 무제한 용량, 압축 지원
- **단점**: 검색 속도 상대적으로 느림

### 3.2 라이프사이클 관리

```
실시간 로그 → File (즉시 접근)
             ↓
           CloudWatch (7-30일, 모니터링용)
             ↓
           S3 Standard (0-90일)
             ↓
           S3 IA (90-365일)
             ↓
           S3 Glacier (365-2555일)
             ↓
           S3 Deep Archive (2555일+)
```

## 4. 비동기 처리 및 성능 최적화

### 4.1 성능 최적화 전략

#### AOP 감사 로깅
- **비동기 처리**: 전용 스레드 풀 사용
- **메인 로직 영향**: 최소화 (논블로킹)
- **배치 처리**: S3 업로드 시 배치로 처리

#### 애플리케이션 로깅
- **AsyncAppender**: Logback 비동기 처리
- **버퍼링**: 메모리 큐 사용으로 성능 향상
- **배치 전송**: CloudWatch API 호출 최적화

### 4.2 오류 처리 및 복구

#### 저장소 장애 시 대응
- **독립적 처리**: 하나의 저장소 실패가 다른 저장소에 영향 없음
- **우아한 성능 저하**: 일부 저장소 실패 시에도 서비스 계속 동작
- **오류 기록**: 저장소별 실패 정보 별도 로깅

## 5. 구조화된 로깅 전략

### 5.1 AOP 감사 로깅 구조

#### JSON 기반 구조화
- **일관된 형식**: 모든 감사 로그는 동일한 JSON 스키마
- **검색 최적화**: 필드별 인덱싱 및 검색 지원
- **확장성**: 새로운 필드 추가 시 하위 호환성 보장

#### 핵심 정보 포함
- **추적 정보**: traceId, 사용자 정보, 세션 정보
- **비즈니스 컨텍스트**: 액션, 메서드, 파라미터
- **기술적 정보**: 실행 시간, 오류 정보, 클라이언트 정보

### 5.2 민감정보 보호

#### 자동 마스킹
- **패턴 기반**: password, token, key 등 민감 키워드 자동 감지
- **설정 가능**: 마스킹 패턴 및 규칙 환경별 설정
- **법적 준수**: GDPR, 개인정보보호법 등 규정 준수

## 6. 모니터링 및 알람 전략

### 6.1 실시간 모니터링

#### CloudWatch 기반 모니터링
- **에러율 추적**: 시간당 ERROR 로그 발생률
- **성능 지표**: 평균 응답 시간, 처리량
- **사용자 활동**: 로그인 패턴, 기능 사용률

#### 자동 알람 설정
- **임계치 기반**: ERROR 로그 임계치 초과 시 자동 알림
- **패턴 감지**: 비정상적인 접근 패턴 감지
- **시스템 상태**: 로깅 시스템 자체의 건강성 모니터링

### 6.2 비용 최적화

#### 환경별 비용 전략
- **개발 환경**: 로컬만 사용하여 $0
- **테스트 환경**: ERROR만 CloudWatch 전송으로 ~$5/월
- **운영 환경**: 완전한 모니터링으로 ~$50/월

#### 비용 절약 방법
- **레벨별 필터링**: 불필요한 DEBUG 로그 제거
- **압축 및 아카이빙**: S3 GZIP 압축으로 70-80% 절약
- **보존 기간 최적화**: 환경별 적절한 보존 기간 설정

## 7. 확장성 및 향후 계획

### 7.1 다중 저장소 확장

#### 현재 지원 저장소
- File, CloudWatch, S3

#### 확장 예정 저장소
- ElasticSearch: 실시간 로그 검색 및 분석
- Kafka: 대용량 실시간 로그 스트리밍
- Database: 구조화된 감사 데이터 직접 저장


